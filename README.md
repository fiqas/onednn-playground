# Mixture of Experts oneDNN testbed

1. Compile, e.g. `mkdir build; cd build; cmake ..; make moe`
2. Run `moe.ipynb` to get a `data.npz` file for reference.
3. Execute built `moe` with `data.npz`, e.g. `build/src/moe data.npz`.

Example output:

```
src_data = (7x5) f {
   1.2362,  1.6277,  0.3380, -1.1993,  0.8633
  -0.1809, -0.6039, -1.2301,  0.5505,  0.7928
  -0.6235,  0.5206, -1.1443,  0.8019,  0.0466
  -0.1866, -0.1017,  0.8689,  0.7504,  0.5295
   0.1377,  0.0778,  0.6184,  0.2325,  0.6826
  -0.3101, -2.4348,  1.0388,  2.1870,  0.4414
  -0.1002, -0.1364, -0.1191,  0.0174, -1.1220
}
router = (3x7) h {
    1,   1,   0,   0,   0,   0,   0
    0,   0,   1,   1,   0,   0,   0
    0,   0,   0,   0,   1,   1,   0
}
expert_0_src_mem = (2x5) f {
   1.2362,  1.6277,  0.3380, -1.1993,  0.8633
  -0.1809, -0.6039, -1.2301,  0.5505,  0.7928
}
expert_0_dst = (2x5) f {
  -3.2026, -1.8308,  1.6229,  1.7417, -1.3465
  -1.3718, -1.7249, -3.7090, -1.2380,  1.5633
}
expected expert_0_dst_mem = (2x5) f {
  -3.2026, -1.8308,  1.6229,  1.7417, -1.3465
  -1.3718, -1.7249, -3.7090, -1.2380,  1.5633
}
dst_data (after expert 0) = (7x5) f {
  -3.2026, -1.8308,  1.6229,  1.7417, -1.3465
  -1.3718, -1.7249, -3.7090, -1.2380,  1.5633
  -0.0624,  0.0521, -0.1144,  0.0802,  0.0047
  -0.0187, -0.0102,  0.0869,  0.0750,  0.0529
   0.0138,  0.0078,  0.0618,  0.0232,  0.0683
  -0.0310, -0.2435,  0.1039,  0.2187,  0.0441
  -0.0100, -0.0136, -0.0119,  0.0017, -0.1122
}
expert_1_src_mem = (2x5) f {
  -0.6235,  0.5206, -1.1443,  0.8019,  0.0466
  -0.1866, -0.1017,  0.8689,  0.7504,  0.5295
}
expert_1_dst = (2x5) f {
   1.9497, -0.5749, -0.1338, -0.4058, -2.6448
  -3.1482, -0.1859, -0.7689,  0.0170,  0.0289
}
expected expert_1_dst_mem = (2x5) f {
   1.9497, -0.5749, -0.1338, -0.4058, -2.6448
  -3.1482, -0.1859, -0.7689,  0.0170,  0.0289
}
dst_data (after expert 1) = (7x5) f {
  -3.2026, -1.8308,  1.6229,  1.7417, -1.3465
  -1.3718, -1.7249, -3.7090, -1.2380,  1.5633
   1.9497, -0.5749, -0.1338, -0.4058, -2.6448
  -3.1482, -0.1859, -0.7689,  0.0170,  0.0289
   0.0138,  0.0078,  0.0618,  0.0232,  0.0683
  -0.0310, -0.2435,  0.1039,  0.2187,  0.0441
  -0.0100, -0.0136, -0.0119,  0.0017, -0.1122
}
expert_2_src_mem = (2x5) f {
   0.1377,  0.0778,  0.6184,  0.2325,  0.6826
  -0.3101, -2.4348,  1.0388,  2.1870,  0.4414
}
expert_2_dst = (2x5) f {
   2.4329,  0.8039,  1.0453,  2.9674, -2.3498
   5.7870, -1.0651,  1.7465, -2.0618, -3.0016
}
expected expert_2_dst_mem = (2x5) f {
   2.4329,  0.8039,  1.0453,  2.9674, -2.3498
   5.7870, -1.0651,  1.7465, -2.0618, -3.0016
}
dst_data (after expert 2) = (7x5) f {
  -3.2026, -1.8308,  1.6229,  1.7417, -1.3465
  -1.3718, -1.7249, -3.7090, -1.2380,  1.5633
   1.9497, -0.5749, -0.1338, -0.4058, -2.6448
  -3.1482, -0.1859, -0.7689,  0.0170,  0.0289
   2.4329,  0.8039,  1.0453,  2.9674, -2.3498
   5.7870, -1.0651,  1.7465, -2.0618, -3.0016
  -0.0100, -0.0136, -0.0119,  0.0017, -0.1122
}
expected dst_data = (7x5) f {
  -3.2026, -1.8308,  1.6229,  1.7417, -1.3465
  -1.3718, -1.7249, -3.7090, -1.2380,  1.5633
   1.9497, -0.5749, -0.1338, -0.4058, -2.6448
  -3.1482, -0.1859, -0.7689,  0.0170,  0.0289
   2.4329,  0.8039,  1.0453,  2.9674, -2.3498
   5.7870, -1.0651,  1.7465, -2.0618, -3.0016
  -0.0100, -0.0136, -0.0119,  0.0017, -0.1122
}
sum(|a-b|) = 0.000002
```

